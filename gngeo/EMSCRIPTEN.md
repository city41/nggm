# Building gngeo in emscripten

## install empscripten

follow instructions here: https://emscripten.org/docs/getting_started/downloads.html

## build generator68k's helper binarys

generator68k builds two helper binaries, `def68k` and `gen68k`. These need to be native binaries for your OS (ie linux).

The easiest way to get these is to just build gngeo natively

1. `autoreconf -iv`
2. `./configure`
3. `make`

When done, head to `src/generator68k` and delete all `cpu68k*.o` files. These were built for native use, but we actually need emscripten to build them for wasm.

Make sure to not delete `cpu68k*.c` files, which were generated by the above binaries.

Also don't delete `def68k.o`, as if it goes missing, make will want to recreate it, and we can't build it with emscripten

## configure for emscripten and build

at root of gngeo

1. `emconfigure ./configure`
2. edit `gngeo/src/Makefile` and add `USE_ZLIB=1` in the two places `USE_SDL=2` is set
3. `emmake make`

If all succeeded, you should have three `a.out.*` files at the root of the repo. These are useless.

## build the emscripten html and bootstrap js

head to `src/`

then...

1. `mv gngeo gngeo.o`
2. `emcc gngeo.o -o gngeo.html -s USE_SDL=2 -s USE_ZLIB=1`

## run it

from `src/`

1. `http-server`
2. head to `http://localhost:8080/gngeo.html`

# Virtual File System

emscripten automatically adds in virtual file system support due to it noticing gngeo making file system calls. This version of gngeo was hardcoded to look for files in `/virtualfs/`, so all the files in that directory get packaged up into gngeo.data by empscripten.

# Gatsby Considerations

It's much easier to load static files from `public/static` when using Gatsby. So the gngeo.data file is located at `static/gngeo.data`, but `gngeo.js` assumes it's at the root of the web server. Easiest fix is to edit gngeo.js and change:

`var REMOTE_PACKAGE_BASE = 'gngeo.data';`

to

`var REMOTE_PACKAGE_BASE = 'static/gngeo.data';`

# TODO

make this much, _much_ nicer! This is just me hacking at gngeo and emscripten till I got something working.
This should be much cleaner and much more automated. But this works for now...
